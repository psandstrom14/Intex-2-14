<!--Paris Ward, Lucas Moraes, Joshua Ethington, Parker Sandstrom-->
<!--This page will allow visitors to donate and add user information-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donate Now - Ella Rises</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="icon" type="image/x-icon" href="/logo.ico" />
</head>
<body>
    <!-- Skip Navigation Link -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <div class="logo">
                <a href="/"><img src="/images/logo.png" alt="Ella Rises Logo"> ELLA RISES</a>
            </div>
            <ul class="nav-links">
                <li><a href="/">Home</a></li>
                <li><a href="/about">About</a></li>
                <li><a href="/performance">Performance</a></li>
                <li><a href="/calendar">Calendar</a></li>
                <li><a href="/donate_now" class="selected-nav">Donate Now</a></li>

                <% if (isLoggedIn && userId) { %>
                    <li><a href="/profile/<%= userId %>">Profile</a></li>
                <% } %>

                <% if (role === "admin") { %>
                    <li class="dropdown">
                        <span class="dropdown-toggle">
                            <a href="#">Pages ‚ñæ</a>
                        </span>
                        <ul class="dropdown-menu">
                            <li><a href="/users">Users</li>
                            <li><a href="/participants">Participants</a></li>
                            <li><a href="/events">Events</a></li>
                            <li><a href="/event_registrations">Event Registrations</a></li>
                            <li><a href="/surveys">Surveys</a></li>
                            <li><a href="/milestones">Milestones</a></li>
                            <li><a href="/donations">Donations</a></li>
                        </ul>
                    </li>
                <% } %>

                <% if (isLoggedIn) { %>
                    <li><a href="/logout" class="login-btn">Logout</a></li>
                <% } else { %>
                    <li><a href="/login" class="login-btn">Login</a></li>
                <% } %>
            </ul>
        </div>
    </nav>

    <!-- Hero Section -->
    <main id="main-content">
    <section class="hero">
        <div class="hero-content">
            <h1>Donate Now</h1>
        </div>
    </section>
    </main>

    <!--Donation Pledge Form Inputs-->
    <!--Main Content-->
    <main id="main-content">
        <div class="container">
            <div class="add-card">
                <!--Add Donations Form-->
                <div id="donationForm">
                    <form id="addForm" class="modern-form">
                        
                        <input type="hidden" name="participant_id" id="participant_id" value="<%= userId %>">
    
                        <div class="form-section">
                            <h2 class="section-title">Donation Details</h2>
                            <p class="section-description">Record the donation information</p>
    
                            <div class="form-group">
                                <label class="form-label">Donation Date <span class="required">*</span></label>
                                <input type="date" class="form-input" name="donation_date" id="donation_date" required>
                            </div>
    
                            <div class="form-group">
                                <label class="form-label">Donation Amount <span class="required">*</span></label>
                                <div class="input-with-prefix">
                                    <span class="input-prefix">$</span>
                                    <input type="number" class="form-input form-input-with-prefix" name="donation_amount" id="donation_amount" placeholder="0.00" min="0.01" step="0.01" required>
                                </div>
                                <span class="form-hint">Enter amount in USD</span>
                            </div>
                        </div>
    
                        <div class="form-actions">
                            <a href="/" class="btn btn-secondary">Cancel</a>
                            <button type="submit" class="btn btn-primary" id="submitBtn">Add Donation</button>
                        </div>
                    </form>
                </div>

                <!--Thank You Message (Hidden by default)-->
                <div id="thankYouMessage" style="display: none;">
                    <div class="form-section" style="text-align: center; padding: 3rem 2rem;">
                        <h2 class="section-title" style="color: #4CAF50; font-size: 2rem; margin-bottom: 1rem;">
                            Thank You for Your Donation! üéâ
                        </h2>
                        <p class="section-description" style="font-size: 1.1rem; margin-bottom: 2rem;">
                            Your generous contribution of <strong id="donationAmountDisplay"></strong> has been successfully recorded.
                            <br><br>
                            Your support makes a difference in empowering women and creating positive change.
                        </p>
                        
                        <div class="form-actions" style="justify-content: center; gap: 1rem;">
                            <button onclick="resetForm()" class="btn btn-primary">Make Another Donation</button>
                            <a href="/profile/<%= userId %>?tab=donations" class="btn btn-secondary">View Donation History</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>    

    <!--Footer-->
    <footer>
        <p>&copy; 2025 Ella Rises. All Rights Reserved.</p>
        <p class="footer-subtext">Making a difference, one woman at a time.</p>

        <div class="custom-language-selector">
            <button class="language-dropdown-btn" onclick="toggleLanguageDropdown()">
                <span id="currentLanguage">
                    <% if (language === 'es') { %>üåê Espa√±ol
                    <% } else if (language === 'fr') { %>üåê Fran√ßais
                    <% } else if (language === 'de') { %>üåê Deutsch
                    <% } else if (language === 'pt') { %>üåê Portugu√™s
                    <% } else if (language === 'ar') { %>üåê ÿßŸÑÿπÿ±ÿ®Ÿäÿ©
                    <% } else if (language === 'zh-CN') { %>üåê ‰∏≠Êñá
                    <% } else if (language === 'ja') { %>üåê Êó•Êú¨Ë™û
                    <% } else if (language === 'ko') { %>üåê ÌïúÍµ≠Ïñ¥
                    <% } else { %>üåê English <% } %>
                </span>
                <span class="dropdown-arrow">‚ñæ</span>
            </button>
            <div class="language-dropdown-menu" id="languageDropdown">
                <a href="#" onclick="changeLanguage('en'); return false;">English</a>
                <a href="#" onclick="changeLanguage('es'); return false;">Espa√±ol</a>
                <a href="#" onclick="changeLanguage('fr'); return false;">Fran√ßais</a>
                <a href="#" onclick="changeLanguage('de'); return false;">Deutsch</a>
                <a href="#" onclick="changeLanguage('pt'); return false;">Portugu√™s</a>
                <a href="#" onclick="changeLanguage('ar'); return false;">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</a>
                <a href="#" onclick="changeLanguage('zh-CN'); return false;">‰∏≠Êñá</a>
                <a href="#" onclick="changeLanguage('ja'); return false;">Êó•Êú¨Ë™û</a>
                <a href="#" onclick="changeLanguage('ko'); return false;">ÌïúÍµ≠Ïñ¥</a>
            </div>
        </div>

        <div id="google_translate_element" style="display:none;"></div>

        <script>
            const LANGUAGE_NAMES = {
                'en': 'üåê English',
                'es': 'üåê Espa√±ol',
                'fr': 'üåê Fran√ßais',
                'de': 'üåê Deutsch',
                'pt': 'üåê Portugu√™s',
                'ar': 'üåê ÿßŸÑÿπÿ±ÿ®Ÿäÿ©',
                'zh-CN': 'üåê ‰∏≠Êñá',
                'ja': 'üåê Êó•Êú¨Ë™û',
                'ko': 'üåê ÌïúÍµ≠Ïñ¥'
            };

            // From server-side session (res.locals.language)
            const SESSION_LANGUAGE = '<%= language || "en" %>';

            // Initialize Google Translate widget ‚Äì no extra logic here
            function googleTranslateElementInit() {
                new google.translate.TranslateElement({
                    pageLanguage: 'en',
                    includedLanguages: 'en,es,fr,de,pt,ar,zh-CN,ja,ko',
                    autoDisplay: false
                }, 'google_translate_element');
            }

            function getGoogTransLang() {
                // Looks for cookie like: googtrans=/auto/es
                const match = document.cookie.match(/(?:^|;)\s*googtrans=\/auto\/([^;]+)/);
                return match ? match[1] : null;
            }

            function setLanguageLabel(lang) {
                const el = document.getElementById('currentLanguage');
                if (!el) return;
                el.textContent = LANGUAGE_NAMES[lang] || LANGUAGE_NAMES['en'];
            }

            function applyLanguage(lang, isInit) {
                const combo = document.querySelector('.goog-te-combo');
                if (!combo) {
                    // Wait for Google widget to finish rendering
                    setTimeout(() => applyLanguage(lang, isInit), 200);
                    return;
                }

                combo.value = lang;
                combo.dispatchEvent(new Event('change'));
                setLanguageLabel(lang);

                if (!isInit) {
                    // Persist to your session on the server
                    fetch('/set-language', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ lang })
                    }).catch(() => {});
                    // Optional: localStorage helper if you want it
                    localStorage.setItem('selectedLanguage', lang);
                    toggleLanguageDropdown(false);
                }
            }

            function changeLanguage(lang) {
                applyLanguage(lang, false);
            }

            function toggleLanguageDropdown(forceClose) {
                const dropdown = document.getElementById('languageDropdown');
                if (!dropdown) return;
                if (forceClose === false) {
                    dropdown.classList.remove('show');
                } else {
                    dropdown.classList.toggle('show');
                }
            }

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.custom-language-selector')) {
                    toggleLanguageDropdown(false);
                }
            });

            document.addEventListener('DOMContentLoaded', () => {
                // Make sure the label matches whatever we think the language is
                setLanguageLabel(SESSION_LANGUAGE);

                const cookieLang = getGoogTransLang();
                const storedLang = localStorage.getItem('selectedLanguage');

                // Priority: Google cookie > session > localStorage
                const preferred =
                    cookieLang ||
                    (SESSION_LANGUAGE && SESSION_LANGUAGE !== 'undefined' ? SESSION_LANGUAGE : null) ||
                    storedLang ||
                    'en';

                // If preferred is English, just leave as-is (no translate flicker)
                if (preferred === 'en') {
                    setLanguageLabel('en');
                    return;
                }

                // Apply preferred language once widget is ready
                setTimeout(() => applyLanguage(preferred, true), 500);
            });
        </script>

        <script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
    </footer>


    <script>
        // Set today's date as default value when page loads
        window.addEventListener('DOMContentLoaded', function() {
            const dateInput = document.getElementById('donation_date');
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            dateInput.value = `${yyyy}-${mm}-${dd}`;
        });

        // Allow Dropdown to handle delay to increase usability
        let dropdownTimeout;
        const dropdown = document.querySelector('.dropdown');
        const dropdownMenu = document.querySelector('.dropdown-menu');

        if (dropdown && dropdownMenu) {
            dropdown.addEventListener('mouseenter', function() {
                clearTimeout(dropdownTimeout);
                dropdownMenu.style.display = 'block';
            });

            dropdown.addEventListener('mouseleave', function() {
                dropdownTimeout = setTimeout(function() {
                    dropdownMenu.style.display = 'none';
                }, 200); // 200ms delay before closing
            });

            dropdownMenu.addEventListener('mouseenter', function() {
                clearTimeout(dropdownTimeout);
                dropdownMenu.style.display = 'block';
            });

            dropdownMenu.addEventListener('mouseleave', function() {
                dropdownTimeout = setTimeout(function() {
                    dropdownMenu.style.display = 'none';
                }, 200);
            });
        }

        // Handle donation form submission
        document.getElementById('addForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Disable submit button to prevent double submission
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';
            
            // Get form values
            const participantId = document.getElementById('participant_id').value;
            const donationDate = document.getElementById('donation_date').value;
            const donationAmount = document.getElementById('donation_amount').value;

            // Validate fields
            if (!participantId || !donationDate || !donationAmount) {
                alert('Please fill out all fields');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Donation';
                return;
            }

            // Create FormData object (this is what your server expects)
            const formData = new URLSearchParams();
            formData.append('participant_id', participantId);
            formData.append('donation_date', donationDate);
            formData.append('donation_amount', donationAmount);

            try {
                const response = await fetch('/add/donations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formData.toString()
                });

                const result = await response.json();

                if (result.success) {
                    // Format the donation amount for display
                    const amount = parseFloat(donationAmount).toFixed(2);
                    document.getElementById('donationAmountDisplay').textContent = '$' + amount;
                    
                    // Hide form and show thank you message
                    document.getElementById('donationForm').style.display = 'none';
                    document.getElementById('thankYouMessage').style.display = 'block';
                    
                    // Scroll to top to show thank you message
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    alert('Error submitting donation: ' + (result.error || 'Unknown error'));
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Add Donation';
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error submitting donation. Please try again.');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Donation';
            }
        });

        // Function to reset form for another donation
        function resetForm() {
            // Reset form fields
            document.getElementById('addForm').reset();
            
            // Re-set today's date
            const dateInput = document.getElementById('donation_date');
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            dateInput.value = `${yyyy}-${mm}-${dd}`;
            
            // Re-enable submit button
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Add Donation';
            
            // Show form and hide thank you message
            document.getElementById('donationForm').style.display = 'block';
            document.getElementById('thankYouMessage').style.display = 'none';
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>
</html>
