<!--Paris Ward, Lucas Moraes, Joshua Ethington, Parker Sandstrom-->
<!--This page displays a calendar with upcoming events-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Calendar - Ella Rises</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="icon" type="image/x-icon" href="/logo.ico" />
</head>
<body>
    <!-- Skip Navigation Link -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <div class="logo">
                <a href="/"><img src="/images/logo.png" alt="Ella Rises Logo"> ELLA RISES</a>
            </div>
            <ul class="nav-links">
                <li><a href="/">Home</a></li>
                <li><a href="/about">About</a></li>
                <li><a href="/performance">Performance</a></li>
                <li><a href="/calendar" class="selected-nav">Calendar</a></li>
                <li><a href="/donate_now">Donate Now</a></li>

                <% if (isLoggedIn && userId) { %>
                    <li><a href="/profile/<%= userId %>">Profile</a></li>
                <% } %>

                <% if (role === "admin") { %>
                    <li class="dropdown">
                        <span class="dropdown-toggle">
                            <a href="#">Pages ‚ñæ</a>
                        </span>
                        <ul class="dropdown-menu">
                            <li><a href="/users">Users</li>
                            <li><a href="/participants">Participants</a></li>
                            <li><a href="/events">Events</a></li>
                            <li><a href="/event_registrations">Event Registrations</a></li>
                            <li><a href="/surveys">Surveys</a></li>
                            <li><a href="/milestones">Milestones</a></li>
                            <li><a href="/donations">Donations</a></li>
                        </ul>
                    </li>
                <% } %>

                <% if (isLoggedIn) { %>
                    <li><a href="/logout" class="login-btn">Logout</a></li>
                <% } else { %>
                    <li><a href="/login" class="login-btn">Login</a></li>
                <% } %>
            </ul>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero hero-compact">
        <div class="hero-content">
            <h1>Event Calendar</h1>
            <p class="hero-subtitle">Click on an event below to learn more about the event details<%= isLoggedIn ? ' & to register for the event!' : '!' %></p>
        </div>
    </section>

    <!-- Flash Messages -->
    <% if (typeof message !== 'undefined' && message) { %>
        <div class="container" style="padding: 1rem 2rem 0;">
            <div class="alert alert-<%= messageType || 'info' %>">
                <%= message %>
            </div>
        </div>
    <% } %>

    <!-- Calendar Legend (only show if user is logged in) -->
    <% if (isLoggedIn) { %>
        <div class="calendar-legend">
            <span class="calendar-legend-title">Legend:</span>
            <div class="calendar-legend-item">
                <div class="calendar-legend-color registered"></div>
                <span class="calendar-legend-label">Registered Events</span>
            </div>
            <div class="calendar-legend-item">
                <div class="calendar-legend-color not-registered"></div>
                <span class="calendar-legend-label">Not Registered</span>
            </div>
        </div>
    <% } %>

    <!-- Calendar Section -->
    <main id="main-content">
    <section class="container" style="padding: 3rem 2rem;">
        
        <!-- Calendar Navigation Wrapper -->
        <div class="calendar-navigation-wrapper">
            <!-- Navigation Buttons (to get user from month to month)-->
            <button class="calendar-nav-btn calendar-nav-prev" id="prevBtn">‚Äπ</button>
            <button class="calendar-nav-btn calendar-nav-next" id="nextBtn">‚Ä∫</button>

            <!-- Calendar Grid -->
            <div class="calendar-grid" id="calendarGrid" data-total-months="<%= months.length %>" data-is-logged-in="<%= isLoggedIn %>">
                <% 
                // Loop through the three months
                for (let i = 0; i < months.length; i++) { 
                    const month = months[i];
                    const isFirst = i === 0;
                %>
                <div class="calendar-card <%= isFirst ? 'active' : '' %>" data-month-index="<%= i %>">
                    <div class="calendar-header">
                        <h2 class="calendar-month-title"><%= month.name %> <%= month.year %></h2>
                    </div>
                    <div class="calendar-body">
                        <!-- Day headers -->
                        <div class="calendar-day-headers">
                            <div class="calendar-day-header">Sun</div>
                            <div class="calendar-day-header">Mon</div>
                            <div class="calendar-day-header">Tue</div>
                            <div class="calendar-day-header">Wed</div>
                            <div class="calendar-day-header">Thu</div>
                            <div class="calendar-day-header">Fri</div>
                            <div class="calendar-day-header">Sat</div>
                        </div>
                        
                        <!-- Calendar days -->
                        <div class="calendar-days">
                            <!-- Empty cells for days before month starts -->
                            <% for (let j = 0; j < month.startDay; j++) { %>
                                <div class="calendar-day calendar-day-empty"></div>
                            <% } %>
                            
                            <!-- Days of the month -->
                            <% for (let day = 1; day <= month.daysInMonth; day++) { 
                                const dateStr = `${month.year}-${String(month.monthNum).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                                const dayEvents = month.events[dateStr] || [];
                                const isToday = dateStr === today;
                                const isPast = new Date(dateStr) < new Date(today);
                            %>
                                <div class="calendar-day 
                                    <%= isToday ? 'calendar-day-today' : '' %> 
                                    <%= dayEvents.length > 0 ? 'calendar-day-has-events' : '' %>
                                    <%= isPast && !isToday ? 'calendar-day-past' : '' %>">
                                    <div class="calendar-day-number"><%= day %></div>
                                    
                                    <% if (dayEvents.length > 0) { %>
                                        <div class="calendar-events">
                                            <% dayEvents.forEach(event => { %>
                                                <div class="calendar-event <%= event.user_registered ? 'calendar-event-registered' : 'calendar-event-not-registered' %>" 
                                                    data-event-id="<%= event.event_id %>"
                                                    data-event-name="<%= event.event_name %>"
                                                    data-event-date="<%= event.event_date %>"
                                                    data-event-start="<%= event.start_time %>"
                                                    data-event-end="<%= event.end_time %>"
                                                    data-event-location="<%= event.location %>"
                                                    data-event-capacity="<%= event.capacity %>"
                                                    data-registered-count="<%= event.registered_count %>"
                                                    data-user-registered="<%= event.user_registered %>"
                                                    data-event-deadline="<%= event.registration_deadline || '' %>">
                                                    <div class="calendar-event-name"><%= event.event_name %></div>
                                                    <div class="calendar-event-time"><%= event.start_time %></div>
                                                </div>
                                            <% }); %>
                                        </div>
                                    <% } %>
                                </div>
                            <% } %>
                        </div>
                    </div>
                </div>
                <% } %>
        </div>
    </div>
    </section>
    </main>

    <!-- Event Modal (displays more information about the event) -->
    <div class="event-modal" id="eventModal">
        <div class="event-modal-content">
            <div class="event-modal-header">
                <h2 class="event-modal-title" id="modalEventName"></h2>
                <button class="event-modal-close" id="closeModal">&times;</button>
            </div>
            <div class="event-modal-body">
                <div class="event-modal-detail">
                    <span class="event-modal-label">Date</span>
                    <div class="event-modal-value" id="modalEventDate"></div>
                </div>
                <div class="event-modal-detail">
                    <span class="event-modal-label">Time</span>
                    <div class="event-modal-value" id="modalEventTime"></div>
                </div>
                <div class="event-modal-detail">
                    <span class="event-modal-label">Location</span>
                    <div class="event-modal-value" id="modalEventLocation"></div>
                </div>
                <div class="event-modal-detail" id="modalCapacitySection">
                    <span class="event-modal-label">Capacity</span>
                    <div class="event-modal-value" id="modalEventCapacity"></div>
                </div>
                <div class="event-modal-detail" id="modalDeadlineSection">
                    <span class="event-modal-label">Registration Deadline</span>
                    <div class="event-modal-value" id="modalEventDeadline"></div>
                </div>
            </div>
            <div class="event-modal-footer" id="eventModalFooter">
                <!-- This will be dynamically populated based on registration status -->
            </div>
        </div>
    </div>

    <!-- Confirmation Modal (confirms if user wants to register)-->
    <div class="event-modal" id="confirmModal">
        <div class="event-modal-content" style="max-width: 450px;">
            <div class="event-modal-header" style="background-color: var(--lavender);">
                <h2 class="event-modal-title">Confirm Registration</h2>
            </div>
            <div class="event-modal-body">
                <p style="font-size: 1.1rem; color: var(--text-dark); text-align: center; margin-bottom: 1.5rem;">
                    Are you sure you want to register for
                </p>
                <p style="font-size: 1.3rem; font-weight: 700; color: var(--lavender); text-align: center; margin-bottom: 0;" id="confirmEventName"></p>
            </div>
            <div class="event-modal-footer" style="display: flex; gap: 1rem;">
                <button class="btn btn-secondary btn-large" id="confirmCancelBtn" style="flex: 1;">
                    Cancel
                </button>
                <button class="btn btn-primary btn-large" id="confirmYesBtn" style="flex: 1;">
                    Yes
                </button>
            </div>
        </div>
    </div>

    <!-- Success Modal (displays success after user registers for an event)-->
    <div class="event-modal" id="successModal">
        <div class="event-modal-content">
            <div class="event-modal-header" style="background-color: var(--sage);">
                <h2 class="event-modal-title">Registration Successful!</h2>
                <button class="event-modal-close" id="closeSuccessModal">&times;</button>
            </div>
            <div class="event-modal-body">
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <p style="font-size: 1.2rem; color: var(--text-dark); margin-bottom: 0.5rem;">
                        Congratulations! You have been registered for
                    </p>
                    <p style="font-size: 1.4rem; font-weight: 700; color: var(--sage);" id="successEventName"></p>
                </div>
                
                <div class="event-modal-detail">
                    <span class="event-modal-label">Date</span>
                    <div class="event-modal-value" id="successEventDate"></div>
                </div>
                <div class="event-modal-detail">
                    <span class="event-modal-label">Time</span>
                    <div class="event-modal-value" id="successEventTime"></div>
                </div>
                <div class="event-modal-detail">
                    <span class="event-modal-label">Location</span>
                    <div class="event-modal-value" id="successEventLocation"></div>
                </div>
            </div>
            <div class="event-modal-footer" style="display: flex; flex-direction: column; gap: 1rem;">
                <a href="#" id="addToGoogleCalendar" class="btn btn-primary btn-large btn-block" target="_blank" rel="noopener noreferrer">
                    Add to Google Calendar
                </a>
                <button class="btn btn-secondary btn-large btn-block" id="returnToCalendarBtn">
                    Return to Calendar
                </button>
            </div>
        </div>
    </div>

    <!-- Error/Info Modal (lets member know they already registered or other issues with registering)-->
    <div class="event-modal" id="infoModal">
        <div class="event-modal-content" style="max-width: 450px;">
            <div class="event-modal-header" id="infoModalHeader">
                <h2 class="event-modal-title" id="infoModalTitle">Notice</h2>
                <button class="event-modal-close" id="closeInfoModal">&times;</button>
            </div>
            <div class="event-modal-body">
                <p style="font-size: 1.1rem; color: var(--text-dark); text-align: center;" id="infoModalMessage"></p>
            </div>
            <div class="event-modal-footer">
                <button class="btn btn-primary btn-large btn-block" id="infoModalOkBtn">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Cancel Confirmation Modal -->
    <div class="event-modal" id="cancelModal">
        <div class="event-modal-content" style="max-width: 450px;">
            <div class="event-modal-header" style="background-color: var(--primary);">
                <h2 class="event-modal-title">Cancel Registration</h2>
            </div>
            <div class="event-modal-body">
                <p style="font-size: 1.1rem; color: var(--text-dark); text-align: center; margin-bottom: 1.5rem;">
                    Are you sure you want to cancel your registration for
                </p>
                <p style="font-size: 1.3rem; font-weight: 700; color: var(--primary); text-align: center; margin-bottom: 0;" id="cancelEventName"></p>
            </div>
            <div class="event-modal-footer" style="display: flex; gap: 1rem;">
                <button class="btn btn-secondary btn-large" id="cancelNoBtn" style="flex: 1;">
                    No, Keep Registration
                </button>
                <button class="btn btn-danger btn-large" id="cancelYesBtn" style="flex: 1;">
                    Yes, Cancel Registration
                </button>
            </div>
        </div>
    </div>

    <!-- Cancel Success Modal -->
    <div class="event-modal" id="cancelSuccessModal">
        <div class="event-modal-content" style="max-width: 450px;">
            <div class="event-modal-header" style="background-color: var(--primary);">
                <h2 class="event-modal-title">Registration Cancelled</h2>
                <button class="event-modal-close" id="closeCancelSuccessModal">&times;</button>
            </div>
            <div class="event-modal-body">
                <p style="font-size: 1.1rem; color: var(--text-dark); text-align: center; margin-bottom: 1rem;">
                    Your registration for
                </p>
                <p style="font-size: 1.3rem; font-weight: 700; color: var(--primary); text-align: center; margin-bottom: 1rem;" id="cancelSuccessEventName"></p>
                <p style="font-size: 1rem; color: var(--text-medium); text-align: center;">
                    has been cancelled successfully.
                </p>
            </div>
            <div class="event-modal-footer">
                <button class="btn btn-primary btn-large btn-block" id="cancelSuccessOkBtn">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!--Footer-->
    <footer>
        <p>&copy; 2025 Ella Rises. All Rights Reserved.</p>
        <p class="footer-subtext">Making a difference, one woman at a time.</p>

        <div class="custom-language-selector">
            <button class="language-dropdown-btn" onclick="toggleLanguageDropdown()">
                <span id="currentLanguage">
                    <% if (language === 'es') { %>üåê Espa√±ol
                    <% } else if (language === 'fr') { %>üåê Fran√ßais
                    <% } else if (language === 'de') { %>üåê Deutsch
                    <% } else if (language === 'pt') { %>üåê Portugu√™s
                    <% } else if (language === 'ar') { %>üåê ÿßŸÑÿπÿ±ÿ®Ÿäÿ©
                    <% } else if (language === 'zh-CN') { %>üåê ‰∏≠Êñá
                    <% } else if (language === 'ja') { %>üåê Êó•Êú¨Ë™û
                    <% } else if (language === 'ko') { %>üåê ÌïúÍµ≠Ïñ¥
                    <% } else { %>üåê English <% } %>
                </span>
                <span class="dropdown-arrow">‚ñæ</span>
            </button>
            <div class="language-dropdown-menu" id="languageDropdown">
                <a href="#" onclick="changeLanguage('en'); return false;">English</a>
                <a href="#" onclick="changeLanguage('es'); return false;">Espa√±ol</a>
                <a href="#" onclick="changeLanguage('fr'); return false;">Fran√ßais</a>
                <a href="#" onclick="changeLanguage('de'); return false;">Deutsch</a>
                <a href="#" onclick="changeLanguage('pt'); return false;">Portugu√™s</a>
                <a href="#" onclick="changeLanguage('ar'); return false;">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</a>
                <a href="#" onclick="changeLanguage('zh-CN'); return false;">‰∏≠Êñá</a>
                <a href="#" onclick="changeLanguage('ja'); return false;">Êó•Êú¨Ë™û</a>
                <a href="#" onclick="changeLanguage('ko'); return false;">ÌïúÍµ≠Ïñ¥</a>
            </div>
        </div>

        <div id="google_translate_element" style="display:none;"></div>

        <script>
            const LANGUAGE_NAMES = {
                'en': 'üåê English',
                'es': 'üåê Espa√±ol',
                'fr': 'üåê Fran√ßais',
                'de': 'üåê Deutsch',
                'pt': 'üåê Portugu√™s',
                'ar': 'üåê ÿßŸÑÿπÿ±ÿ®Ÿäÿ©',
                'zh-CN': 'üåê ‰∏≠Êñá',
                'ja': 'üåê Êó•Êú¨Ë™û',
                'ko': 'üåê ÌïúÍµ≠Ïñ¥'
            };

            // From server-side session (res.locals.language)
            const SESSION_LANGUAGE = '<%= language || "en" %>';

            // Initialize Google Translate widget ‚Äì no extra logic here
            function googleTranslateElementInit() {
                new google.translate.TranslateElement({
                    pageLanguage: 'en',
                    includedLanguages: 'en,es,fr,de,pt,ar,zh-CN,ja,ko',
                    autoDisplay: false
                }, 'google_translate_element');
            }

            function getGoogTransLang() {
                // Looks for cookie like: googtrans=/auto/es
                const match = document.cookie.match(/(?:^|;)\s*googtrans=\/auto\/([^;]+)/);
                return match ? match[1] : null;
            }

            function setLanguageLabel(lang) {
                const el = document.getElementById('currentLanguage');
                if (!el) return;
                el.textContent = LANGUAGE_NAMES[lang] || LANGUAGE_NAMES['en'];
            }

            function applyLanguage(lang, isInit) {
                const combo = document.querySelector('.goog-te-combo');
                if (!combo) {
                    // Wait for Google widget to finish rendering
                    setTimeout(() => applyLanguage(lang, isInit), 200);
                    return;
                }

                combo.value = lang;
                combo.dispatchEvent(new Event('change'));
                setLanguageLabel(lang);

                if (!isInit) {
                    // Persist to your session on the server
                    fetch('/set-language', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ lang })
                    }).catch(() => {});
                    // Optional: localStorage helper if you want it
                    localStorage.setItem('selectedLanguage', lang);
                    toggleLanguageDropdown(false);
                }
            }

            function changeLanguage(lang) {
                applyLanguage(lang, false);
            }

            function toggleLanguageDropdown(forceClose) {
                const dropdown = document.getElementById('languageDropdown');
                if (!dropdown) return;
                if (forceClose === false) {
                    dropdown.classList.remove('show');
                } else {
                    dropdown.classList.toggle('show');
                }
            }

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.custom-language-selector')) {
                    toggleLanguageDropdown(false);
                }
            });

            document.addEventListener('DOMContentLoaded', () => {
                // Make sure the label matches whatever we think the language is
                setLanguageLabel(SESSION_LANGUAGE);

                const cookieLang = getGoogTransLang();
                const storedLang = localStorage.getItem('selectedLanguage');

                // Priority: Google cookie > session > localStorage
                const preferred =
                    cookieLang ||
                    (SESSION_LANGUAGE && SESSION_LANGUAGE !== 'undefined' ? SESSION_LANGUAGE : null) ||
                    storedLang ||
                    'en';

                // If preferred is English, just leave as-is (no translate flicker)
                if (preferred === 'en') {
                    setLanguageLabel('en');
                    return;
                }

                // Apply preferred language once widget is ready
                setTimeout(() => applyLanguage(preferred, true), 500);
            });
        </script>

        <script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
    </footer>


    <script>
    // Wait for DOM to be fully loaded
    (function() {
        'use strict';
        
        // Current month index
        let currentMonthIndex = 0;
        
        // Store pending registration info
        let pendingRegistration = null;
        
        // Store pending cancellation info
        let pendingCancellation = null;

        // Get total months and login status from data attributes
        const calendarGrid = document.getElementById('calendarGrid');
        const totalMonths = parseInt(calendarGrid.getAttribute('data-total-months')) || 3;
        const isLoggedIn = calendarGrid.getAttribute('data-is-logged-in') === 'true';

        // Initialize everything when DOM is ready
        function init() {
            console.log('Initializing calendar...');
            console.log('Total months:', totalMonths);
            console.log('User logged in:', isLoggedIn);
            
            updateNavigationButtons();
            setupEventListeners();
        }

        // Setup all event listeners
        function setupEventListeners() {
            // Navigation buttons
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (prevBtn) {
                prevBtn.onclick = function() {
                    changeMonth(-1);
                };
            }

            if (nextBtn) {
                nextBtn.onclick = function() {
                    changeMonth(1);
                };
            }

            // Event clicks
            const eventElements = document.querySelectorAll('.calendar-event');
            console.log('Found events:', eventElements.length);
            
            eventElements.forEach(function(eventEl) {
                eventEl.onclick = function(e) {
                    e.stopPropagation();
                    openEventModal(this);
                };
            });

            // Modal close buttons
            const closeModalBtn = document.getElementById('closeModal');
            if (closeModalBtn) {
                closeModalBtn.onclick = closeEventModal;
            }

            const closeSuccessModalBtn = document.getElementById('closeSuccessModal');
            if (closeSuccessModalBtn) {
                closeSuccessModalBtn.onclick = closeSuccessModal;
            }

            // Confirmation modal buttons
            const confirmYesBtn = document.getElementById('confirmYesBtn');
            if (confirmYesBtn) {
                confirmYesBtn.onclick = proceedWithRegistration;
            }
            
            const confirmCancelBtn = document.getElementById('confirmCancelBtn');
            if (confirmCancelBtn) {
                confirmCancelBtn.onclick = closeConfirmModal;
            }
            
            // Info modal buttons
            const closeInfoModalBtn = document.getElementById('closeInfoModal');
            if (closeInfoModalBtn) {
                closeInfoModalBtn.onclick = closeInfoModal;
            }
            
            const infoModalOkBtn = document.getElementById('infoModalOkBtn');
            if (infoModalOkBtn) {
                infoModalOkBtn.onclick = closeInfoModal;
            }

            // Return to calendar button
            const returnToCalendarBtn = document.getElementById('returnToCalendarBtn');
            if (returnToCalendarBtn) {
                returnToCalendarBtn.onclick = closeSuccessModal;
            }

            // Cancel confirmation modal buttons
            const cancelYesBtn = document.getElementById('cancelYesBtn');
            if (cancelYesBtn) {
                cancelYesBtn.onclick = proceedWithCancellation;
            }

            const cancelNoBtn = document.getElementById('cancelNoBtn');
            if (cancelNoBtn) {
                cancelNoBtn.onclick = closeCancelModal;
            }

            // Cancel success modal buttons
            const closeCancelSuccessModalBtn = document.getElementById('closeCancelSuccessModal');
            if (closeCancelSuccessModalBtn) {
                closeCancelSuccessModalBtn.onclick = closeCancelSuccessModal;
            }

            const cancelSuccessOkBtn = document.getElementById('cancelSuccessOkBtn');
            if (cancelSuccessOkBtn) {
                cancelSuccessOkBtn.onclick = closeCancelSuccessModal;
            }

            // Close modals when clicking outside
            const modal = document.getElementById('eventModal');
            if (modal) {
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        closeEventModal();
                    }
                };
            }

            const successModal = document.getElementById('successModal');
            if (successModal) {
                successModal.onclick = function(e) {
                    if (e.target === successModal) {
                        closeSuccessModal();
                    }
                };
            }

            const confirmModal = document.getElementById('confirmModal');
            if (confirmModal) {
                confirmModal.onclick = function(e) {
                    if (e.target === confirmModal) {
                        closeConfirmModal();
                    }
                };
            }
            
            const infoModal = document.getElementById('infoModal');
            if (infoModal) {
                infoModal.onclick = function(e) {
                    if (e.target === infoModal) {
                        closeInfoModal();
                    }
                };
            }

            const cancelModal = document.getElementById('cancelModal');
            if (cancelModal) {
                cancelModal.onclick = function(e) {
                    if (e.target === cancelModal) {
                        closeCancelModal();
                    }
                };
            }

            const cancelSuccessModal = document.getElementById('cancelSuccessModal');
            if (cancelSuccessModal) {
                cancelSuccessModal.onclick = function(e) {
                    if (e.target === cancelSuccessModal) {
                        closeCancelSuccessModal();
                    }
                };
            }

            // Keyboard navigation
            document.onkeydown = function(e) {
                if (e.key === 'ArrowLeft') {
                    changeMonth(-1);
                } else if (e.key === 'ArrowRight') {
                    changeMonth(1);
                } else if (e.key === 'Escape') {
                    closeEventModal();
                    closeSuccessModal();
                    closeConfirmModal();
                    closeInfoModal();
                    closeCancelModal();
                    closeCancelSuccessModal();
                }
            };
        }

        // Change month in carousel
        function changeMonth(direction) {
            const newIndex = currentMonthIndex + direction;
            
            // Check bounds
            if (newIndex < 0 || newIndex >= totalMonths) {
                return;
            }

            currentMonthIndex = newIndex;

            // Update active card
            const cards = document.querySelectorAll('.calendar-card');
            
            cards.forEach(function(card, index) {
                if (index === currentMonthIndex) {
                    card.classList.add('active');
                } else {
                    card.classList.remove('active');
                }
            });

            updateNavigationButtons();
        }

        // Update navigation button states
        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (prevBtn) {
                prevBtn.disabled = (currentMonthIndex === 0);
            }
            
            if (nextBtn) {
                nextBtn.disabled = (currentMonthIndex === totalMonths - 1);
            }
        }

        // Open event modal
        function openEventModal(eventElement) {
            const eventId = eventElement.getAttribute('data-event-id');
            const eventName = eventElement.getAttribute('data-event-name');
            const eventDate = eventElement.getAttribute('data-event-date');
            const eventStart = eventElement.getAttribute('data-event-start');
            const eventEnd = eventElement.getAttribute('data-event-end');
            const eventLocation = eventElement.getAttribute('data-event-location');
            const eventCapacity = eventElement.getAttribute('data-event-capacity');
            const registeredCount = eventElement.getAttribute('data-registered-count');
            const eventDeadline = eventElement.getAttribute('data-event-deadline');
            const userRegistered = eventElement.getAttribute('data-user-registered') === 'true';

            // Populate modal
            document.getElementById('modalEventName').textContent = eventName;
            
            // Format date
            const date = new Date(eventDate);
            const formattedDate = date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            document.getElementById('modalEventDate').textContent = formattedDate;
            
            document.getElementById('modalEventTime').textContent = eventStart + ' - ' + eventEnd;
            document.getElementById('modalEventLocation').textContent = eventLocation;
            
            // Capacity with registration count
            const capacitySection = document.getElementById('modalCapacitySection');
            let isFull = false;
            
            if (eventCapacity && eventCapacity !== 'undefined') {
                const capacity = parseInt(eventCapacity);
                const registered = parseInt(registeredCount) || 0;
                const seatsLeft = capacity - registered;
                
                let capacityText = '';
                if (seatsLeft > 0) {
                    capacityText = registered + '/' + capacity + ' seats filled (' + seatsLeft + ' seats left)';
                } else if (seatsLeft === 0) {
                    capacityText = registered + '/' + capacity + ' seats filled (FULL)';
                    isFull = true;
                } else {
                    capacityText = registered + '/' + capacity + ' seats filled (OVERBOOKED)';
                    isFull = true;
                }
                
                document.getElementById('modalEventCapacity').textContent = capacityText;
                capacitySection.style.display = 'block';
            } else {
                capacitySection.style.display = 'none';
            }

            // Deadline
            const deadlineSection = document.getElementById('modalDeadlineSection');
            if (eventDeadline && eventDeadline !== 'undefined' && eventDeadline !== '') {
                const deadline = new Date(eventDeadline);
                const formattedDeadline = deadline.toLocaleDateString('en-US', { 
                    month: 'long', 
                    day: 'numeric', 
                    year: 'numeric' 
                });
                document.getElementById('modalEventDeadline').textContent = formattedDeadline;
                deadlineSection.style.display = 'block';
            } else {
                deadlineSection.style.display = 'none';
            }

            // Handle footer buttons based on login and registration status
            const footer = document.getElementById('eventModalFooter');
            footer.innerHTML = '';
            
            // Check if user is logged in
            if (!isLoggedIn) {
                // User is not logged in - show login button
                footer.innerHTML = `
                    <a href="/login" class="btn btn-primary btn-large btn-block">
                        Login to Register
                    </a>
                `;
            } else if (userRegistered) {
                // User is already registered - show status and cancel button
                footer.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 1rem; width: 100%;">
                        <button class="btn btn-success btn-large btn-block" disabled>
                            ‚úì Already Registered
                        </button>
                        <button class="btn btn-danger btn-large btn-block" id="cancelRegistrationBtn">
                            Cancel Registration
                        </button>
                    </div>
                `;
                
                // Add event listener to cancel button
                const cancelBtn = document.getElementById('cancelRegistrationBtn');
                if (cancelBtn) {
                    cancelBtn.onclick = function() {
                        handleCancelRegistration(eventId, eventName);
                    };
                }
            } else if (isFull) {
                // Event is full
                footer.innerHTML = `
                    <button class="btn btn-danger btn-large btn-block" disabled>
                        Event Full
                    </button>
                `;
            } else {
                // Available to register
                footer.innerHTML = `
                    <button class="btn btn-primary btn-large btn-block" id="registerEventBtn">
                        Register for Event
                    </button>
                `;
                
                // Add event listener to register button
                const registerBtn = document.getElementById('registerEventBtn');
                if (registerBtn) {
                    registerBtn.onclick = function() {
                        handleEventRegistration(eventId, eventName);
                    };
                }
            }

            // Show modal
            const modal = document.getElementById('eventModal');
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }

        // Handle event registration with custom confirmation modal
        function handleEventRegistration(eventId, eventName) {
            // Store the registration info
            pendingRegistration = { eventId: eventId, eventName: eventName };
            
            // Show custom confirmation modal
            document.getElementById('confirmEventName').textContent = eventName;
            document.getElementById('confirmModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Proceed with registration after confirmation
        function proceedWithRegistration() {
            if (!pendingRegistration) return;
            
            const eventId = pendingRegistration.eventId;
            
            // Close confirmation modal
            closeConfirmModal();
            
            // Close event details modal
            closeEventModal();
            
            // Make AJAX request to register
            fetch('/register-event/' + eventId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.success) {
                    // Show success modal
                    showSuccessModal(data.event);
                } else {
                    // Show error in custom modal
                    showInfoModal(data.message || 'Registration failed. Please try again.', 'error');
                    
                    // If needs to redirect (e.g., to login)
                    if (data.redirect) {
                        setTimeout(function() {
                            window.location.href = data.redirect;
                        }, 2000);
                    }
                }
            })
            .catch(function(error) {
                console.error('Error:', error);
                showInfoModal('An error occurred during registration. Please try again.', 'error');
            })
            .finally(function() {
                pendingRegistration = null;
            });
        }

        // Show custom info/error modal
        function showInfoModal(message, type) {
            const modal = document.getElementById('infoModal');
            const header = document.getElementById('infoModalHeader');
            const title = document.getElementById('infoModalTitle');
            const messageEl = document.getElementById('infoModalMessage');
            
            // Set message
            messageEl.textContent = message;
            
            // Set style based on type
            header.classList.remove('error-header', 'warning-header', 'info-header');
            
            if (type === 'error') {
                header.classList.add('error-header');
                title.textContent = 'Error';
            } else if (type === 'warning') {
                header.classList.add('warning-header');
                title.textContent = 'Notice';
            } else {
                header.classList.add('info-header');
                title.textContent = 'Information';
            }
            
            // Show modal
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Show success modal with event details
        function showSuccessModal(event) {
            // Populate success modal
            document.getElementById('successEventName').textContent = event.event_name;
            
            // Format date
            const date = new Date(event.event_date);
            const formattedDate = date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            document.getElementById('successEventDate').textContent = formattedDate;
            
            // Format time
            document.getElementById('successEventTime').textContent = event.event_start_time + ' - ' + event.event_end_time;
            document.getElementById('successEventLocation').textContent = event.event_location;
            
            // Build Google Calendar URL
            const googleCalendarUrl = 'https://www.google.com/calendar/render?action=TEMPLATE' +
                '&text=' + encodeURIComponent(event.event_name) +
                '&dates=' + event.start_gcal + '/' + event.end_gcal +
                '&details=' + encodeURIComponent('You are registered for this Ella Rises event!') +
                '&location=' + encodeURIComponent(event.event_location || '');
            
            document.getElementById('addToGoogleCalendar').href = googleCalendarUrl;
            
            // Show modal
            document.getElementById('successModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Handle cancel registration request
        function handleCancelRegistration(eventId, eventName) {
            // Store the cancellation info
            pendingCancellation = { eventId: eventId, eventName: eventName };
            
            // Show custom cancel confirmation modal
            document.getElementById('cancelEventName').textContent = eventName;
            document.getElementById('cancelModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Proceed with cancellation after confirmation
        function proceedWithCancellation() {
            if (!pendingCancellation) return;
            
            const eventId = pendingCancellation.eventId;
            const eventName = pendingCancellation.eventName;
            
            // Close cancel confirmation modal
            closeCancelModal();
            
            // Close event details modal
            closeEventModal();
            
            // Make AJAX request to cancel registration
            fetch('/cancel-registration/' + eventId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.success) {
                    // Show cancel success modal
                    showCancelSuccessModal(eventName);
                } else {
                    // Show error in custom modal
                    showInfoModal(data.message || 'Failed to cancel registration. Please try again.', 'error');
                }
            })
            .catch(function(error) {
                console.error('Error:', error);
                showInfoModal('An error occurred while cancelling registration. Please try again.', 'error');
            })
            .finally(function() {
                pendingCancellation = null;
            });
        }

        // Show cancel success modal
        function showCancelSuccessModal(eventName) {
            document.getElementById('cancelSuccessEventName').textContent = eventName;
            document.getElementById('cancelSuccessModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Close event modal
        function closeEventModal() {
            const modal = document.getElementById('eventModal');
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }
        }

        // Close confirmation modal
        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.remove('active');
            document.body.style.overflow = '';
            pendingRegistration = null;
        }

        // Close info modal
        function closeInfoModal() {
            document.getElementById('infoModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Close success modal
        function closeSuccessModal() {
            document.getElementById('successModal').classList.remove('active');
            document.body.style.overflow = '';
            
            // Reload the page to update registration counts
            window.location.reload();
        }

        // Close cancel confirmation modal
        function closeCancelModal() {
            document.getElementById('cancelModal').classList.remove('active');
            document.body.style.overflow = '';
            pendingCancellation = null;
        }

        // Close cancel success modal
        function closeCancelSuccessModal() {
            document.getElementById('cancelSuccessModal').classList.remove('active');
            document.body.style.overflow = '';
            
            // Reload the page to update registration counts and colors
            window.location.reload();
        }

        // Dropdown functionality
        function setupDropdown() {
            let dropdownTimeout;
            const dropdown = document.querySelector('.dropdown');
            const dropdownMenu = document.querySelector('.dropdown-menu');

            if (dropdown && dropdownMenu) {
                dropdown.onmouseenter = function() {
                    clearTimeout(dropdownTimeout);
                    dropdownMenu.style.display = 'block';
                };

                dropdown.onmouseleave = function() {
                    dropdownTimeout = setTimeout(function() {
                        dropdownMenu.style.display = 'none';
                    }, 200);
                };

                dropdownMenu.onmouseenter = function() {
                    clearTimeout(dropdownTimeout);
                    dropdownMenu.style.display = 'block';
                };

                dropdownMenu.onmouseleave = function() {
                    dropdownTimeout = setTimeout(function() {
                        dropdownMenu.style.display = 'none';
                    }, 200);
                };
            }
        }

        // Start everything when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                init();
                setupDropdown();
            });
        } else {
            init();
            setupDropdown();
        }
    })();
    </script>
</body>
</html>
