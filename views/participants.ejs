<!--Paris Ward, Lucas Moraes, Joshua Ethington, Parker Sandstrom-->
<!--This page will display participants, and allow CRUD (for managers) + Search Capabilities.-->
<!--This page will only be visible to users who are logged in.-->
<!--Ability to maintain milestones for participants-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Participants - Ella Rises</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <div class="logo">Ella Rises</div>
            <ul class="nav-links">
                <li><a href="/">Home</a></li>
                <li><a href="/about">About</a></li>
                <li><a href="/donate_now">Donate Now</a></li>
                <li class="dropdown">
                    <span class="dropdown-toggle">
                        <a href="#" class="selected-nav">Pages â–¾</a>
                    </span>
                    <ul class="dropdown-menu">
                        <li><a href="/users">Users</a></li>
                        <li><a href="/participants">Participants</a></li>
                        <li><a href="/events">Events</a></li>
                        <li><a href="/surveys">Surveys</a></li>
                        <li><a href="/milestones">Milestones</a></li>
                        <li><a href="/donations">Donations</a></li>
                    </ul>
                </li>
                <li><a href="/login" class="login-btn">Login</a></li>
            </ul>
        </div>
    </nav>

    <!-- Page Header -->
    <div class="page-header">
        <h1>Participants</h1>
        <p>Manage and view all participant information</p>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Success/Error Messages -->
        <% if (typeof message !== 'undefined' && message) { %>
            <div class="alert alert-<%= messageType || 'success' %>">
                <%= message %>
            </div>
        <% } %>

        <!-- Search and Actions Bar -->
        <div class="table-container">
            <div class="table-header">
                <h2 class="table-title">All Participants</h2>
                <div class="table-actions">
                    <button class="btn btn-primary" onclick="window.location.href='/participants/add'">
                        + Add Participant
                    </button>
                </div>
            </div>

            <!-- Search and Filter Section -->
            <div class="filter-section">
                <div class="filter-row">
                    <!-- Basic Search -->
                    <div class="filter-item" style="flex: 2;">
                        <label class="form-label">Quick Search (First Name)</label>
                        <div class="search-input-group">
                            <input type="text" id="quickSearch" class="form-control" placeholder="Search by first name...">
                            <button class="btn btn-primary" id="quickSearchBtn">
                                Search
                            </button>
                        </div>
                    </div>

                    <!-- Advanced Search Toggle -->
                    <div class="filter-item" style="flex: 0.8;">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-secondary filter-toggle-btn" id="toggleAdvancedSearch">
                            Advanced Search
                        </button>
                    </div>
                </div>

                <!-- Advanced Search (Hidden by default) -->
                <form id="filterForm" method="POST" action="/filter">
                    <div id="advancedSearchSection" style="display: none; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e0e0e0;">
                        
                        <!-- 1. Advanced Search -->
                        <h3 style="color: #7eb8b8; margin-bottom: 1rem; font-size: 1.1rem;">1. Advanced Search</h3>
                        <div class="filter-row" style="margin-bottom: 2rem;">
                            <div class="filter-item">
                                <label class="form-label">Search Field</label>
                                <select name="searchColumn" id="advancedSearchColumn" class="form-control">
                                    <option value="">Select field...</option>
                                    <option value="participant_first_name" <%= (typeof filters !== 'undefined' && filters.searchColumn === 'participant_first_name') ? 'selected' : '' %>>First Name</option>
                                    <option value="participant_last_name" <%= (typeof filters !== 'undefined' && filters.searchColumn === 'participant_last_name') ? 'selected' : '' %>>Last Name</option>
                                    <option value="participant_email" <%= (typeof filters !== 'undefined' && filters.searchColumn === 'participant_email') ? 'selected' : '' %>>Email</option>
                                    <option value="participant_phone" <%= (typeof filters !== 'undefined' && filters.searchColumn === 'participant_phone') ? 'selected' : '' %>>Phone</option>
                                    <option value="participant_city" <%= (typeof filters !== 'undefined' && filters.searchColumn === 'participant_city') ? 'selected' : '' %>>City</option>
                                    <option value="participant_state" <%= (typeof filters !== 'undefined' && filters.searchColumn === 'participant_state') ? 'selected' : '' %>>State</option>
                                    <option value="participant_school_or_employer" <%= (typeof filters !== 'undefined' && filters.searchColumn === 'participant_school_or_employer') ? 'selected' : '' %>>School/Employer</option>
                                    <option value="participant_field_of_interest" <%= (typeof filters !== 'undefined' && filters.searchColumn === 'participant_field_of_interest') ? 'selected' : '' %>>Field of Interest</option>
                                </select>
                            </div>
                            <div class="filter-item" style="flex: 2;">
                                <label class="form-label">Search Value</label>
                                <input type="text" name="searchValue" id="advancedSearchValue" class="form-control" placeholder="Enter search term..." value="<%= (typeof filters !== 'undefined') ? filters.searchValue : '' %>">
                            </div>
                        </div>

                        <!-- 2. Filters -->
                        <h3 style="color: #7eb8b8; margin-bottom: 1rem; font-size: 1.1rem;">2. Filters</h3>
                        <div class="filter-cards-grid">
                            <!-- City Filter -->
                            <div class="card">
                                <div class="card-header">
                                    <h4 style="color: #666; font-size: 1rem;">City</h4>
                                </div>
                                <div class="card-body" style="max-height: 200px; overflow-y: auto;">
                                    <% 
                                    const cityFilters = (typeof filters !== 'undefined' && filters.city) ? filters.city : ['all'];
                                    const isCityAll = cityFilters.includes('all');
                                    %>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="city" value="all" class="city-checkbox" <%= isCityAll ? 'checked' : '' %>> All
                                    </label>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="city" value="Bountiful" class="city-checkbox" <%= cityFilters.includes('Bountiful') ? 'checked' : '' %>> Bountiful
                                    </label>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="city" value="Draper" class="city-checkbox" <%= cityFilters.includes('Draper') ? 'checked' : '' %>> Draper
                                    </label>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="city" value="Layton" class="city-checkbox" <%= cityFilters.includes('Layton') ? 'checked' : '' %>> Layton
                                    </label>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="city" value="Lehi" class="city-checkbox" <%= cityFilters.includes('Lehi') ? 'checked' : '' %>> Lehi
                                    </label>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="city" value="Logan" class="city-checkbox" <%= cityFilters.includes('Logan') ? 'checked' : '' %>> Logan
                                    </label>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="city" value="Murray" class="city-checkbox" <%= cityFilters.includes('Murray') ? 'checked' : '' %>> Murray
                                    </label>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="city" value="Ogden" class="city-checkbox" <%= cityFilters.includes('Ogden') ? 'checked' : '' %>> Ogden
                                    </label>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="city" value="Orem" class="city-checkbox" <%= cityFilters.includes('Orem') ? 'checked' : '' %>> Orem
                                    </label>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="city" value="Pleasant Grove" class="city-checkbox" <%= cityFilters.includes('Pleasant Grove') ? 'checked' : '' %>> Pleasant Grove
                                    </label>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="city" value="Provo" class="city-checkbox" <%= cityFilters.includes('Provo') ? 'checked' : '' %>> Provo
                                    </label>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="city" value="Riverton" class="city-checkbox" <%= cityFilters.includes('Riverton') ? 'checked' : '' %>> Riverton
                                    </label>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="city" value="Salt Lake City" class="city-checkbox" <%= cityFilters.includes('Salt Lake City') ? 'checked' : '' %>> Salt Lake City
                                    </label>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="city" value="Sandy" class="city-checkbox" <%= cityFilters.includes('Sandy') ? 'checked' : '' %>> Sandy
                                    </label>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="city" value="Spanish Fork" class="city-checkbox" <%= cityFilters.includes('Spanish Fork') ? 'checked' : '' %>> Spanish Fork
                                    </label>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="city" value="St. George" class="city-checkbox" <%= cityFilters.includes('St. George') ? 'checked' : '' %>> St. George
                                    </label>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="city" value="Taylorsville" class="city-checkbox" <%= cityFilters.includes('Taylorsville') ? 'checked' : '' %>> Taylorsville
                                    </label>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="city" value="West Jordan" class="city-checkbox" <%= cityFilters.includes('West Jordan') ? 'checked' : '' %>> West Jordan
                                    </label>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="city" value="West Valley City" class="city-checkbox" <%= cityFilters.includes('West Valley City') ? 'checked' : '' %>> West Valley City
                                    </label>
                                </div>
                            </div>

                            <!-- School/Employer Filter -->
                            <div class="card">
                                <div class="card-header">
                                    <h4 style="color: #666; font-size: 1rem;">School/Employer</h4>
                                </div>
                                <div class="card-body" style="max-height: 200px; overflow-y: auto;">
                                    <% 
                                    const schoolFilters = (typeof filters !== 'undefined' && filters.school) ? filters.school : ['all'];
                                    const isSchoolAll = schoolFilters.includes('all');
                                    %>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="school" value="all" class="school-checkbox" <%= isSchoolAll ? 'checked' : '' %>> All
                                    </label>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="school" value="Art Studio" class="school-checkbox" <%= schoolFilters.includes('Art Studio') ? 'checked' : '' %>> Art Studio
                                    </label>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="school" value="BYU" class="school-checkbox" <%= schoolFilters.includes('BYU') ? 'checked' : '' %>> BYU
                                    </label>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="school" value="Cafe Rio" class="school-checkbox" <%= schoolFilters.includes('Cafe Rio') ? 'checked' : '' %>> Cafe Rio
                                    </label>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="school" value="Community Center" class="school-checkbox" <%= schoolFilters.includes('Community Center') ? 'checked' : '' %>> Community Center
                                    </label>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="school" value="East Ridge Middle" class="school-checkbox" <%= schoolFilters.includes('East Ridge Middle') ? 'checked' : '' %>> East Ridge Middle
                                    </label>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="school" value="Ella Rises" class="school-checkbox" <%= schoolFilters.includes('Ella Rises') ? 'checked' : '' %>> Ella Rises
                                    </label>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="school" value="Local Library" class="school-checkbox" <%= schoolFilters.includes('Local Library') ? 'checked' : '' %>> Local Library
                                    </label>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="school" value="Mountain View High" class="school-checkbox" <%= schoolFilters.includes('Mountain View High') ? 'checked' : '' %>> Mountain View High
                                    </label>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="school" value="North Summit High" class="school-checkbox" <%= schoolFilters.includes('North Summit High') ? 'checked' : '' %>> North Summit High
                                    </label>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="school" value="Retail Store" class="school-checkbox" <%= schoolFilters.includes('Retail Store') ? 'checked' : '' %>> Retail Store
                                    </label>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="school" value="UVU" class="school-checkbox" <%= schoolFilters.includes('UVU') ? 'checked' : '' %>> UVU
                                    </label>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="school" value="Startup Lab" class="school-checkbox" <%= schoolFilters.includes('Startup Lab') ? 'checked' : '' %>> Startup Lab
                                    </label>
                                </div>
                            </div>

                            <!-- Field of Interest Filter -->
                            <div class="card">
                                <div class="card-header">
                                    <h4 style="color: #666; font-size: 1rem;">Field of Interest</h4>
                                </div>
                                <div class="card-body">
                                    <% 
                                    const interestFilters = (typeof filters !== 'undefined' && filters.interest) ? filters.interest : ['all'];
                                    const isInterestAll = interestFilters.includes('all');
                                    %>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="interest" value="all" class="interest-checkbox" <%= isInterestAll ? 'checked' : '' %>> All
                                    </label>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="interest" value="Arts" class="interest-checkbox" <%= interestFilters.includes('Arts') ? 'checked' : '' %>> Arts
                                    </label>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="interest" value="Both" class="interest-checkbox" <%= interestFilters.includes('Both') ? 'checked' : '' %>> Both
                                    </label>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="interest" value="STEM" class="interest-checkbox" <%= interestFilters.includes('STEM') ? 'checked' : '' %>> STEM
                                    </label>
                                </div>
                            </div>

                            <!-- Donations Filter -->
                            <div class="card">
                                <div class="card-header">
                                    <h4 style="color: #666; font-size: 1rem;">Has Donations</h4>
                                </div>
                                <div class="card-body">
                                    <% 
                                    const donationFilters = (typeof filters !== 'undefined' && filters.donations) ? filters.donations : ['all'];
                                    const isDonationsAll = donationFilters.includes('all');
                                    %>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="donations" value="all" class="donations-checkbox" <%= isDonationsAll ? 'checked' : '' %>> All
                                    </label>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="donations" value="Yes" class="donations-checkbox" <%= donationFilters.includes('Yes') ? 'checked' : '' %>> Yes
                                    </label>
                                    <label style="display: block; margin-bottom: 0.5rem;">
                                        <input type="checkbox" name="donations" value="No" class="donations-checkbox" <%= donationFilters.includes('No') ? 'checked' : '' %>> No
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- 3. Sorting -->
                        <h3 style="color: #7eb8b8; margin-bottom: 1rem; font-size: 1.1rem;">3. Sorting</h3>
                        <div class="filter-row" style="margin-bottom: 1.5rem;">
                            <div class="filter-item">
                                <label class="form-label">Sort By</label>
                                <select name="sortColumn" id="sortColumn" class="form-control">
                                    <option value="">Select field...</option>
                                    <option value="participant_first_name" <%= (typeof filters !== 'undefined' && filters.sortColumn === 'participant_first_name') ? 'selected' : '' %>>First Name</option>
                                    <option value="participant_last_name" <%= (typeof filters !== 'undefined' && filters.sortColumn === 'participant_last_name') ? 'selected' : '' %>>Last Name</option>
                                    <option value="participant_email" <%= (typeof filters !== 'undefined' && filters.sortColumn === 'participant_email') ? 'selected' : '' %>>Email</option>
                                    <option value="participant_phone" <%= (typeof filters !== 'undefined' && filters.sortColumn === 'participant_phone') ? 'selected' : '' %>>Phone</option>
                                    <option value="participant_dob" <%= (typeof filters !== 'undefined' && filters.sortColumn === 'participant_dob') ? 'selected' : '' %>>Date of Birth</option>
                                    <option value="participant_city" <%= (typeof filters !== 'undefined' && filters.sortColumn === 'participant_city') ? 'selected' : '' %>>City</option>
                                    <option value="total_donations" <%= (typeof filters !== 'undefined' && filters.sortColumn === 'total_donations') ? 'selected' : '' %>>Total Donations</option>
                                </select>
                            </div>
                            <div class="filter-item">
                                <label class="form-label">Order</label>
                                <select name="sortOrder" id="sortOrder" class="form-control">
                                    <option value="asc" <%= (typeof filters !== 'undefined' && filters.sortOrder === 'asc') ? 'selected' : '' %>>Ascending (A-Z, Oldest-Newest, Low-High)</option>
                                    <option value="desc" <%= (typeof filters !== 'undefined' && filters.sortOrder === 'desc') ? 'selected' : '' %>>Descending (Z-A, Newest-Oldest, High-Low)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="filter-row">
                            <div class="filter-item" style="flex: 0.8;">
                                <button type="submit" class="btn btn-primary btn-small" style="width: 100%;">
                                    Apply Filters
                                </button>
                            </div>
                            <div class="filter-item" style="flex: 0.8;">
                                <button type="button" class="btn btn-outline btn-small" id="clearAdvancedSearch" style="width: 100%;">
                                    Clear Filters
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Bulk Actions Bar (Hidden by default) -->
            <div id="bulkActionsBar" style="display: none; background-color: #f8f0f0; padding: 1rem 1.5rem; border-bottom: 1px solid #e0e0e0;">
                <div class="flex-between">
                    <div>
                        <span id="selectedCount" style="font-weight: 600; color: #666;">0 selected</span>
                    </div>
                    <div class="flex gap-2">
                        <button class="btn btn-secondary btn-small" id="editSelected" style="display: none;">
                            Edit
                        </button>
                        <button class="btn btn-danger btn-small" id="deleteSelected">
                            Delete Selected
                        </button>
                        <button class="btn btn-outline btn-small" id="clearSelection">
                            Clear Selection
                        </button>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 40px;">
                                <input type="checkbox" id="selectAll">
                            </th>
                            <th>First Name</th>
                            <th>Last Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Date of Birth</th>
                            <th>City</th>
                            <th>State</th>
                            <th>Zip</th>
                            <th>School/Employer</th>
                            <th>Field of Interest</th>
                            <th>Total Donations</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data rows will be inserted here from your backend -->
                        <% if (typeof participant !== 'undefined' && participant.length > 0) { %>
                            <% participant.forEach(function(p) { %>
                                <% 
                                    // Format date of birth
                                    let formattedDOB = '';
                                    if (p.participant_dob) {
                                        const dob = new Date(p.participant_dob);
                                        const month = String(dob.getMonth() + 1).padStart(2, '0');
                                        const day = String(dob.getDate()).padStart(2, '0');
                                        const year = dob.getFullYear();
                                        formattedDOB = `${month}/${day}/${year}`;
                                    }
                                %>
                                <tr data-id="<%= p.participant_id %>">
                                    <td>
                                        <input type="checkbox" class="row-checkbox" value="<%= p.participant_id %>" data-name="<%= p.participant_first_name %> <%= p.participant_last_name %>">
                                    </td>
                                    <td><%= p.participant_first_name %></td>
                                    <td><%= p.participant_last_name %></td>
                                    <td><%= p.participant_email %></td>
                                    <td><%= p.participant_phone %></td>
                                    <td><%= formattedDOB %></td>
                                    <td><%= p.participant_city %></td>
                                    <td><%= p.participant_state %></td>
                                    <td><%= p.participant_zip %></td>
                                    <td><%= p.participant_school_or_employer %></td>
                                    <td><%= p.participant_field_of_interest %></td>
                                    <td>$<%= p.total_donations || '0.00' %></td>
                                </tr>
                            <% }); %>
                        <% } else { %>
                            <tr>
                                <td colspan="12" style="text-align: center; padding: 3rem; color: #999;">
                                    No participants found. Click "Add Participant" to get started.
                                </td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <p>&copy; 2025 Ella Rises. All Rights Reserved.</p>
        <p style="margin-top: 1rem; font-size: 0.9rem;">Making a difference, one woman at a time.</p>
    </footer>

    <script>
        // Dropdown handling
        let dropdownTimeout;
        const dropdown = document.querySelector('.dropdown');
        const dropdownMenu = document.querySelector('.dropdown-menu');

        if (dropdown && dropdownMenu) {
            dropdown.addEventListener('mouseenter', function() {
                clearTimeout(dropdownTimeout);
                dropdownMenu.style.display = 'block';
            });

            dropdown.addEventListener('mouseleave', function() {
                dropdownTimeout = setTimeout(function() {
                    dropdownMenu.style.display = 'none';
                }, 200);
            });

            dropdownMenu.addEventListener('mouseenter', function() {
                clearTimeout(dropdownTimeout);
                dropdownMenu.style.display = 'block';
            });

            dropdownMenu.addEventListener('mouseleave', function() {
                dropdownTimeout = setTimeout(function() {
                    dropdownMenu.style.display = 'none';
                }, 200);
            });
        }

        // Advanced Search Toggle
        document.getElementById('toggleAdvancedSearch').addEventListener('click', function() {
            const advSection = document.getElementById('advancedSearchSection');
            if (advSection.style.display === 'none') {
                advSection.style.display = 'block';
                this.textContent = 'Hide Advanced';
            } else {
                advSection.style.display = 'none';
                this.textContent = 'Advanced Search';
            }
        });

        // Filter checkbox handling - City
        const cityCheckboxes = document.querySelectorAll('.city-checkbox');
        const cityAllCheckbox = document.querySelector('.city-checkbox[value="all"]');
        
        cityCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                if (this.value === 'all' && this.checked) {
                    // If "All" is checked, uncheck others
                    cityCheckboxes.forEach(cb => {
                        if (cb.value !== 'all') cb.checked = false;
                    });
                } else if (this.value !== 'all' && this.checked) {
                    // If any specific option is checked, uncheck "All"
                    cityAllCheckbox.checked = false;
                } else if (this.value !== 'all' && !this.checked) {
                    // If unchecking a specific option and no others are checked, check "All"
                    const anyChecked = Array.from(cityCheckboxes).some(cb => cb.value !== 'all' && cb.checked);
                    if (!anyChecked) {
                        cityAllCheckbox.checked = true;
                    }
                }
            });
        });

        // Filter checkbox handling - School
        const schoolCheckboxes = document.querySelectorAll('.school-checkbox');
        const schoolAllCheckbox = document.querySelector('.school-checkbox[value="all"]');
        
        schoolCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                if (this.value === 'all' && this.checked) {
                    schoolCheckboxes.forEach(cb => {
                        if (cb.value !== 'all') cb.checked = false;
                    });
                } else if (this.value !== 'all' && this.checked) {
                    schoolAllCheckbox.checked = false;
                } else if (this.value !== 'all' && !this.checked) {
                    const anyChecked = Array.from(schoolCheckboxes).some(cb => cb.value !== 'all' && cb.checked);
                    if (!anyChecked) {
                        schoolAllCheckbox.checked = true;
                    }
                }
            });
        });

        // Filter checkbox handling - Interest
        const interestCheckboxes = document.querySelectorAll('.interest-checkbox');
        const interestAllCheckbox = document.querySelector('.interest-checkbox[value="all"]');
        
        interestCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                if (this.value === 'all' && this.checked) {
                    interestCheckboxes.forEach(cb => {
                        if (cb.value !== 'all') cb.checked = false;
                    });
                } else if (this.value !== 'all' && this.checked) {
                    interestAllCheckbox.checked = false;
                } else if (this.value !== 'all' && !this.checked) {
                    const anyChecked = Array.from(interestCheckboxes).some(cb => cb.value !== 'all' && cb.checked);
                    if (!anyChecked) {
                        interestAllCheckbox.checked = true;
                    }
                }
            });
        });

        // Filter checkbox handling - Donations
        const donationsCheckboxes = document.querySelectorAll('.donations-checkbox');
        const donationsAllCheckbox = document.querySelector('.donations-checkbox[value="all"]');
        
        donationsCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                if (this.value === 'all' && this.checked) {
                    donationsCheckboxes.forEach(cb => {
                        if (cb.value !== 'all') cb.checked = false;
                    });
                } else if (this.value !== 'all' && this.checked) {
                    donationsAllCheckbox.checked = false;
                } else if (this.value !== 'all' && !this.checked) {
                    const anyChecked = Array.from(donationsCheckboxes).some(cb => cb.value !== 'all' && cb.checked);
                    if (!anyChecked) {
                        donationsAllCheckbox.checked = true;
                    }
                }
            });
        });

        // Checkbox Selection Handling
        const selectAllCheckbox = document.getElementById('selectAll');
        const bulkActionsBar = document.getElementById('bulkActionsBar');
        const selectedCountSpan = document.getElementById('selectedCount');
        const editButton = document.getElementById('editSelected');

        selectAllCheckbox.addEventListener('change', function() {
            const rowCheckboxes = document.querySelectorAll('.row-checkbox');
            rowCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateBulkActions();
        });

        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('row-checkbox')) {
                updateBulkActions();
            }
        });

        function updateBulkActions() {
            const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
            const count = checkedBoxes.length;

            if (count > 0) {
                bulkActionsBar.style.display = 'block';
                selectedCountSpan.textContent = count + ' selected';
                
                if (count === 1) {
                    editButton.style.display = 'inline-block';
                } else {
                    editButton.style.display = 'none';
                }
            } else {
                bulkActionsBar.style.display = 'none';
                editButton.style.display = 'none';
            }

            const rowCheckboxes = document.querySelectorAll('.row-checkbox');
            selectAllCheckbox.checked = count === rowCheckboxes.length && count > 0;
        }

        // Clear Selection
        document.getElementById('clearSelection').addEventListener('click', function() {
            const rowCheckboxes = document.querySelectorAll('.row-checkbox');
            rowCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            selectAllCheckbox.checked = false;
            updateBulkActions();
        });

        // Edit Selected (single item)
        document.getElementById('editSelected').addEventListener('click', function() {
            const checkedBox = document.querySelector('.row-checkbox:checked');
            if (checkedBox) {
                const participantId = checkedBox.value;
                window.location.href = '/participants/edit/' + participantId;
            }
        });

        // Delete Selected (bulk)
        document.getElementById('deleteSelected').addEventListener('click', function() {
            const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
            const ids = Array.from(checkedBoxes).map(cb => cb.value);
            const count = ids.length;
            
            let confirmMessage;
            if (count === 1) {
                const name = checkedBoxes[0].getAttribute('data-name');
                confirmMessage = `Are you sure you want to delete ${name}?`;
            } else {
                confirmMessage = `Are you sure you want to delete ${count} participants?`;
            }
            
            showDeleteConfirmation(confirmMessage, function() {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/participants/delete-multiple';
                
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'ids';
                input.value = JSON.stringify(ids);
                form.appendChild(input);
                
                document.body.appendChild(form);
                form.submit();
            });
        });

        // Delete Confirmation Modal
        function showDeleteConfirmation(message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'deleteModal';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Confirm Deletion</h3>
                        <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p style="font-size: 1.1rem; color: #666;">${message}</p>
                        <p style="margin-top: 1rem; color: #999;">This action cannot be undone.</p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline" onclick="closeDeleteModal()">Cancel</button>
                        <button class="btn btn-danger" id="confirmDeleteBtn">Yes, Delete</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
                closeDeleteModal();
                onConfirm();
            });
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeDeleteModal();
                }
            });
        }

        function closeDeleteModal() {
            const modal = document.getElementById('deleteModal');
            if (modal) {
                modal.remove();
            }
        }

        // Quick Search (client-side filtering - First Name only)
        const quickSearchInput = document.getElementById('quickSearch');
        const quickSearchBtn = document.getElementById('quickSearchBtn');
        
        function performQuickSearch() {
            const searchTerm = quickSearchInput.value.toLowerCase();
            const rows = document.querySelectorAll('tbody tr[data-id]');
            
            rows.forEach(row => {
                const firstName = row.cells[1]?.textContent.toLowerCase() || '';
                
                if (firstName.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        quickSearchBtn.addEventListener('click', performQuickSearch);
        
        quickSearchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                performQuickSearch();
            }
        });

        // Clear Advanced Search
        document.getElementById('clearAdvancedSearch').addEventListener('click', function() {
            document.getElementById('advancedSearchColumn').value = '';
            document.getElementById('advancedSearchValue').value = '';
            document.getElementById('sortColumn').value = '';
            document.getElementById('sortOrder').selectedIndex = 0;
            
            // Reset all checkboxes to "All"
            cityCheckboxes.forEach(cb => cb.checked = cb.value === 'all');
            schoolCheckboxes.forEach(cb => cb.checked = cb.value === 'all');
            interestCheckboxes.forEach(cb => cb.checked = cb.value === 'all');
            donationsCheckboxes.forEach(cb => cb.checked = cb.value === 'all');
            
            window.location.href = '/participants';
        });

        // Auto-hide success/error messages after 5 seconds
        const alertMessages = document.querySelectorAll('.alert');
        alertMessages.forEach(alert => {
            setTimeout(() => {
                alert.style.transition = 'opacity 0.5s';
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 500);
            }, 5000);
        });
    </script>
</body>
</html>